{
  "title": "lang::report_8_engagement::local_kopere_bi",
  "description": "lang::report_8_student_teacher_engagement::local_kopere_bi",
  "user_id": null,
  "refkey": "engagement",
  "category": {
    "refkey": "login_reports",
    "title": "lang::report_6_cat_title::local_kopere_bi",
    "description": "lang::report_6_cat_description::local_kopere_bi"
  },
  "blocks": [
    {
      "refkey": "login_reports-1",
      "type": "block-1",
      "sequence": 1,
      "elements": [
        {
          "title": "lang::report_8_teacher_access::local_kopere_bi",
          "refkey": "report_8_teacher_access",
          "block_num": 1,
          "type": "table",
          "theme": "light",
          "css": "",
          "html_before": null,
          "html_after": null,
          "commandsql": "SELECT \n    u.id        AS u_id,\n    u.firstname,\n    u.lastname,\n    COUNT(DISTINCT ctx.instanceid)  AS num_courses,\n    SUM(l.learners)                 AS num_learners,\n    SUM(l1.activelearners)          AS num_activelearners,\n    SUM(cc.completed)               AS num_completedlearners,\n    AVG(g.grade)                    AS grade\nFROM \n    mdl_user u\nLEFT JOIN mdl_role_assignments AS ra ON ra.userid = u.id\nLEFT JOIN mdl_context AS ctx ON ctx.id = ra.contextid\nJOIN mdl_course c ON ctx.instanceid = c.id AND c.visible = 1\nLEFT JOIN (\n    SELECT \n        ctx.instanceid, \n        COUNT(DISTINCT ra.userid) AS learners\n    FROM \n        mdl_role_assignments ra,\n        mdl_context ctx\n    WHERE \n        ctx.id = ra.contextid\n        AND ctx.contextlevel = 50\n        AND ra.roleid = 5\n    GROUP BY \n        ctx.instanceid\n) AS l ON l.instanceid = ctx.instanceid\nLEFT JOIN (\n    SELECT \n        ctx.instanceid, \n        COUNT(DISTINCT ra.userid) AS activelearners\n    FROM \n        mdl_role_assignments ra,\n        mdl_user u,\n        mdl_context ctx\n    WHERE \n        ctx.id = ra.contextid\n        AND ctx.contextlevel = 50\n        AND u.id = ra.userid\n        -- AND u.lastaccess BETWEEN 1707755694 AND 1710347694\n        AND u.deleted = 0\n        AND u.suspended = 0\n        AND ra.roleid = 5\n    GROUP BY \n        ctx.instanceid\n) AS l1 ON l1.instanceid = ctx.instanceid\nLEFT JOIN (\n    SELECT \n        course, \n        COUNT(id) AS completed\n    FROM \n        mdl_course_completions\n    WHERE \n        timecompleted > 0\n    GROUP BY \n        course\n) cc ON cc.course = ctx.instanceid\nLEFT JOIN (\n    SELECT \n        gi.courseid,\n        ROUND(AVG(CASE\n            WHEN g.rawgrademax > 0 THEN (g.finalgrade \/ g.rawgrademax) * 100\n            ELSE g.finalgrade \n        END), 0) AS grade\n    FROM \n        mdl_grade_items gi,\n        mdl_grade_grades g\n    WHERE \n        gi.itemtype = 'course'\n        AND g.itemid = gi.id\n        AND g.finalgrade IS NOT NULL\n    GROUP BY \n        gi.courseid\n) g ON g.courseid = ctx.instanceid\nWHERE ctx.contextlevel = 50\n  AND ra.roleid        = 3\n  AND u.deleted        = 0\n  AND u.suspended      = 0\nGROUP BY u.id, u.firstname, u.lastname",
          "cache": "30m",
          "reload": "30m",
          "info": "{\"column\":{\"u_id\":{\"key\":\"u_id\",\"title\":\"#\",\"type\":\"userphotoRenderer\",\"mustache\":\"\"},\"firstname\":{\"key\":\"firstname\",\"title\":\"lang::u_fullname::local_kopere_bi\",\"type\":\"userfullname\",\"mustache\":\"<a href=\\\"{{{config.wwwroot}}}\\\/user\\\/view.php?id={{{u_id}}}\\\"\\r\\n   target=\\\"profile\\\">{{{u_fullname}}}<\\\/a>\"},\"lastname\":{\"key\":\"lastname\",\"title\":\"\",\"type\":\"none\",\"mustache\":\"\"},\"num_courses\":{\"key\":\"num_courses\",\"title\":\"lang::num_courses::local_kopere_bi\",\"type\":\"number\",\"mustache\":\"\"},\"num_learners\":{\"key\":\"num_learners\",\"title\":\"lang::num_learners::local_kopere_bi\",\"type\":\"number\",\"mustache\":\"\"},\"num_activelearners\":{\"key\":\"num_activelearners\",\"title\":\"lang::num_activelearners::local_kopere_bi\",\"type\":\"number\",\"mustache\":\"\"},\"num_completedlearners\":{\"key\":\"num_completedlearners\",\"title\":\"lang::num_completedlearners::local_kopere_bi\",\"type\":\"number\",\"mustache\":\"\"},\"grade\":{\"key\":\"grade\",\"title\":\"lang::grade::local_kopere_bi\",\"type\":\"number\",\"mustache\":\"\"}}}"
        }
      ]
    },
    {
      "refkey": "login_reports-2",
      "type": "block-1",
      "sequence": 2,
      "elements": [
        {
          "title": "lang::report_2_total_engagement::local_kopere_bi",
          "refkey": "report_2_total_engagement",
          "block_num": 1,
          "type": "table",
          "theme": "light",
          "css": "",
          "html_before": "",
          "html_after": "",
          "commandsql": "SELECT c.id       AS c_id,\n       c.fullname AS c_fullname,\n       COUNT(DISTINCT ra.userid) AS num_learners,\n       COUNT(DISTINCT CASE\n           WHEN comp.userid IS NOT NULL AND ula.id IS NOT NULL THEN u.id\n           ELSE NULL \n       END) AS completed_learners,\n       COUNT(DISTINCT CASE\n           WHEN comp.userid IS NULL AND ula.id IS NOT NULL THEN u.id\n           ELSE NULL \n       END) AS not_completed_learners,\n       COUNT(DISTINCT CASE \n           WHEN ula.id IS NULL THEN u.id \n           ELSE NULL \n       END) AS not_accessed_learners\nFROM mdl_role_assignments ra\nJOIN mdl_context AS ctx \n    ON ctx.id = ra.contextid AND ctx.contextlevel = 50\nJOIN mdl_course c \n    ON c.id = ctx.instanceid\nJOIN mdl_user u \n    ON u.id = ra.userid\nLEFT JOIN (\n    SELECT cm.course, cmc.userid\n    FROM mdl_course_modules cm\n    JOIN mdl_course_modules_completion cmc \n        ON cmc.coursemoduleid = cm.id AND cmc.completionstate = 1\n    WHERE cmc.id > 0\n    GROUP BY cm.course, cmc.userid\n) comp \n    ON comp.userid = u.id AND comp.course = c.id\nLEFT JOIN mdl_user_lastaccess ula \n    ON ula.courseid = c.id AND ula.userid = ra.userid\nWHERE c.id > 0\n  AND u.deleted = 0\n  AND u.suspended = 0\n  AND c.visible = 1\n  AND ra.roleid = 5\nGROUP BY c.id",
          "cache": "30m",
          "reload": "30m",
          "info": "{\"column\":{\"c_id\":{\"key\":\"c_id\",\"title\":\"#\",\"type\":\"none\",\"mustache\":\"\"},\"c_fullname\":{\"key\":\"c_fullname\",\"title\":\"lang::c_fullname::local_kopere_bi\",\"type\":\"string\",\"mustache\":\"<a href=\\\"{{{config.wwwroot}}}\\\/course\\\/view.php?id={{{c_id}}}\\\"\\r\\n   target=\\\"course\\\">{{{c_fullname}}}<\\\/a>\"},\"num_learners\":{\"key\":\"num_learners\",\"title\":\"lang::num_learners::local_kopere_bi\",\"type\":\"number\",\"mustache\":\"\"},\"completed_learners\":{\"key\":\"completed_learners\",\"title\":\"lang::completed_learners::local_kopere_bi\",\"type\":\"string\",\"mustache\":\"<div id=\\\"{{{uniqid}}}\\\" class=\\\"progress-bar-container\\\" style=\\\"background: #E0E0E0;height: 30px;position: relative;border-radius: 4px;overflow: hidden;\\\">\\r\\n    <div class=\\\"progress-bar\\\" style=\\\"position: absolute;background-color: #6eafe6;\\\"><\\\/div>\\r\\n    <div class=\\\"progress-text\\\" style=\\\"height: 30px;display: flex;position: absolute;align-items: center;justify-content: center;width: 100%;\\\">\\r\\n        {{{completed_learners}}} \\\/ {{{num_learners}}}\\r\\n    <\\\/div>\\r\\n<\\\/div>\\r\\n<script>\\r\\n    var percentage = ({{{completed_learners}}} \\\/ {{{num_learners}}}) * 100;\\r\\n    $(\\\"#{{{uniqid}}} .progress-bar\\\")\\r\\n        .css({\\r\\n            width : percentage+\\\"%\\\"\\r\\n        })\\r\\n<\\\/script>\"},\"not_completed_learners\":{\"key\":\"not_completed_learners\",\"title\":\"lang::not_completed_learners::local_kopere_bi\",\"type\":\"string\",\"mustache\":\"<div id=\\\"{{{uniqid}}}\\\" class=\\\"progress-bar-container\\\" style=\\\"background: #E0E0E0;height: 30px;position: relative;border-radius: 4px;overflow: hidden;\\\">\\r\\n    <div class=\\\"progress-bar\\\" style=\\\"position: absolute;background-color: #6eafe6;\\\"><\\\/div>\\r\\n    <div class=\\\"progress-text\\\" style=\\\"height: 30px;display: flex;position: absolute;align-items: center;justify-content: center;width: 100%;\\\">\\r\\n        {{{not_completed_learners}}} \\\/ {{{num_learners}}}\\r\\n    <\\\/div>\\r\\n<\\\/div>\\r\\n<script>\\r\\n    var percentage = ({{{not_completed_learners}}} \\\/ {{{num_learners}}}) * 100;\\r\\n    $(\\\"#{{{uniqid}}} .progress-bar\\\")\\r\\n        .css({\\r\\n            width : percentage+\\\"%\\\"\\r\\n        })\\r\\n<\\\/script>\"},\"not_accessed_learners\":{\"key\":\"not_accessed_learners\",\"title\":\"lang::not_accessed_learners::local_kopere_bi\",\"type\":\"string\",\"mustache\":\"<div id=\\\"{{{uniqid}}}\\\" class=\\\"progress-bar-container\\\" style=\\\"background: #E0E0E0;height: 30px;position: relative;border-radius: 4px;overflow: hidden;\\\">\\r\\n    <div class=\\\"progress-bar\\\" style=\\\"position: absolute;background-color: #6eafe6;\\\"><\\\/div>\\r\\n    <div class=\\\"progress-text\\\" style=\\\"height: 30px;display: flex;position: absolute;align-items: center;justify-content: center;width: 100%;\\\">\\r\\n        {{{not_accessed_learners}}} \\\/ {{{num_learners}}}\\r\\n    <\\\/div>\\r\\n<\\\/div>\\r\\n<script>\\r\\n    var percentage = ({{{not_accessed_learners}}} \\\/ {{{num_learners}}}) * 100;\\r\\n    $(\\\"#{{{uniqid}}} .progress-bar\\\")\\r\\n        .css({\\r\\n            width : percentage+\\\"%\\\"\\r\\n        })\\r\\n<\\\/script>\"}}}"
        }
      ]
    }
  ]
}
